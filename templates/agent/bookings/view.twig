{% extends 'agent/layout.twig' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>Заявка #{{ booking.id }}</h1>
  <div>
    <button id="gen-docs" class="btn btn-sm btn-outline-secondary">Сформировать документы</button>
    <a href="/agent/bookings/{{ booking.id }}/payment/invoice" class="btn btn-sm btn-outline-primary">Счет (PDF)</a>
    <a href="/agent/bookings/{{ booking.id }}/payment/online" class="btn btn-sm btn-success">Онлайн-оплата</a>
  </div>
</div>

<div class="row g-3">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Клиент</h5>
        <p>{{ booking.customer_name|e }}<br>{{ booking.customer_phone|e }}<br>{{ booking.customer_email|e }}</p>
        <p><strong>Сумма:</strong> {{ booking.total_amount|e }}</p>
        <p><strong>Статус заказа:</strong>
          {% set omap = {'new':'Новая','in_progress':'В работе','paid':'Оплачен','cancel_request':'Запрос на аннуляцию','cancelled':'Аннуляция','waitlist':'Лист ожидания','confirmed':'Подтвержден','rejected':'Отказ','on_request':'Под запрос'} %}
          {% set oclass = {'new':'secondary','in_progress':'info','paid':'success','cancel_request':'warning','cancelled':'dark','waitlist':'secondary','confirmed':'primary','rejected':'danger','on_request':'warning'} %}
          {% set ov = booking.order_status|default(booking.status|default('new')) %}
          <span class="badge bg-{{ oclass[ov]|default('secondary') }}">{{ omap[ov]|default(ov) }}</span>
        </p>
        <p><strong>Статус оплаты:</strong>
          {% set pmap = {'paid':'Оплачен','unpaid':'Не оплачен','cancelled':'Отменен','partial':'Оплачен не полностью'} %}
          {% set pclass = {'paid':'success','unpaid':'secondary','cancelled':'dark','partial':'warning'} %}
          {% set pv = booking.payment_status|default('unpaid') %}
          <span class="badge bg-{{ pclass[pv]|default('secondary') }}">{{ pmap[pv]|default(pv) }}</span>
        </p>
        <p><strong>Тур:</strong> {{ booking.tour_title|e }}</p>
        {% if booking.id %}
        {% set seats = [] %}
        {% if booking.seats is defined %}
          {% set seats = booking.seats %}
        {% endif %}
        {% if seats|length > 0 %}
        <p><strong>Места в автобусе:</strong> {{ seats|join(', ') }}</p>
        {% endif %}
        {% endif %}
        <hr>
        <form method="post" action="/agent/bookings/{{ booking.id }}/comment" class="mt-2">
          <input type="hidden" name="_csrf" value="{{ csrf }}">
          <label class="form-label">Комментарий агента (виден администратору)</label>
          <textarea class="form-control" name="agent_comment" rows="3" placeholder="Ваш комментарий">{{ booking.agent_comment|default('')|e }}</textarea>
          <button class="btn btn-sm btn-primary mt-2">Сохранить комментарий</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Туристы</h5>
        <ul class="list-group list-group-flush">
          {% for t in tourists %}
          <li class="list-group-item">{{ t.full_name|e }}, {{ t.birth_date|e }}, {{ t.passport|e }}, {{ t.phone|e }}, {{ t.email|e }}</li>
          {% else %}
          <li class="list-group-item text-muted">Нет туристов</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<div id="docs" class="mt-3"></div>

{# duplicate comment block removed #}

{% endblock %}

{% block scripts %}
<script>
$('#gen-docs').on('click', function(){
  $.post('/agent/bookings/{{ booking.id }}/documents', {}, function(resp){
    if(resp.ok){
      let html = '<h5>Документы</h5><ul>';
      Object.entries(resp.files).forEach(([k,v]) => {
        html += `<li><a href="${v}" target="_blank">${k}.pdf</a></li>`;
      });
      html += '</ul>';
      $('#docs').html(html);
    }
  });
});
</script>
{% endblock %}

